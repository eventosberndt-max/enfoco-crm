<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enfoco CRM</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=IBM+Plex+Mono:wght@400;500&family=Syne:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0a0b;--s1:#111113;--s2:#18181b;--s3:#222226;--border:#2e2e34;
  --gold:#f0c040;--gold2:#c89a20;--goldbg:#1a1500;
  --green:#3dba7a;--greenbg:#071812;
  --red:#e05555;--redbg:#1a0707;
  --orange:#e88c30;--orangebg:#1a0e00;
  --blue:#4d8fd4;--bluebg:#070f1a;
  --purple:#9b72e0;--purplebg:#0f0a1a;
  --text:#e8e4dc;--muted:#6b6860;--muted2:#4a4845;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh;overflow-x:hidden}
body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");pointer-events:none;z-index:999;opacity:.6}

/* LAYOUT */
.shell{display:grid;grid-template-columns:220px 1fr;min-height:100vh}

/* SIDEBAR */
.sidebar{background:var(--s1);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto}
.logo-block{padding:24px 20px 20px;border-bottom:1px solid var(--border)}
.logo-name{font-family:'Playfair Display',serif;font-size:18px;color:var(--gold)}
.logo-tag{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:3px}
.nav{padding:12px;flex:1;display:flex;flex-direction:column;gap:2px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:7px;cursor:pointer;color:var(--muted);font-size:13px;font-weight:500;transition:all .15s;border:none;background:none;width:100%;text-align:left}
.nav-item:hover{background:var(--s2);color:var(--text)}
.nav-item.active{background:rgba(240,192,64,.1);color:var(--gold);border-left:2px solid var(--gold)}
.nav-item .ni{font-size:14px;width:20px;text-align:center}
.nav-sep{height:1px;background:var(--border);margin:8px 0}
.sidebar-footer{padding:14px 20px;border-top:1px solid var(--border)}
.api-dot{width:6px;height:6px;border-radius:50%;background:var(--red);display:inline-block;margin-right:6px}
.api-dot.ok{background:var(--green)}
.api-status-text{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted)}

/* MAIN */
.main{display:flex;flex-direction:column;min-height:100vh}
.topbar{padding:18px 28px;border-bottom:1px solid var(--border);background:var(--s1);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
.page-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--text)}
.page-title em{color:var(--gold);font-style:italic}
.topbar-right{display:flex;gap:8px;align-items:center}
.content{padding:24px 28px;flex:1}

/* PANELS */
.panel{display:none;flex-direction:column;gap:18px;animation:fadeIn .18s ease}
.panel.active{display:flex}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* SEARCH */
.search-bar{position:relative;margin-bottom:4px}
.search-bar input{width:100%;background:var(--s2);border:1px solid var(--border);color:var(--text);padding:10px 14px 10px 36px;border-radius:9px;font-family:'Syne',sans-serif;font-size:13px;outline:none;transition:border-color .15s}
.search-bar input:focus{border-color:var(--gold)}
.search-bar::before{content:'‚åï';position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:16px;pointer-events:none}

/* WEEKLY GRID */
.week-header{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:4px}
.week-day-label{text-align:center;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);padding:6px 0}
.week-day-label.today{color:var(--gold)}
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;align-items:start}
.week-col{background:var(--s1);border:1px solid var(--border);border-radius:10px;min-height:80px;padding:8px;display:flex;flex-direction:column;gap:6px}
.week-col.today-col{border-color:rgba(240,192,64,.35);background:rgba(240,192,64,.03)}
.week-date{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted);text-align:center;margin-bottom:4px}
.week-date.today{color:var(--gold);font-weight:600}

/* LEAD PILLS (weekly) */
.lead-pill{background:var(--s2);border:1px solid var(--border);border-radius:7px;padding:7px 9px;cursor:pointer;transition:all .15s;border-left:3px solid var(--muted2)}
.lead-pill:hover{border-color:var(--gold);background:var(--s3)}
.lead-pill.urgent{border-left-color:var(--red)}
.lead-pill.today-p{border-left-color:var(--orange)}
.lead-pill.ok{border-left-color:var(--green)}
.pill-empresa{font-size:11px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pill-contacto{font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pill-canal{font-size:9px;font-family:'IBM Plex Mono',monospace;margin-top:3px}

/* LEAD CARDS (leads panel) */
.leads-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.lead-card{background:var(--s1);border:1px solid var(--border);border-radius:11px;padding:16px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden}
.lead-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px}
.lead-card.urgent::before{background:var(--red)}
.lead-card.today-c::before{background:var(--orange)}
.lead-card.ok::before{background:var(--green)}
.lead-card.neutral::before{background:var(--muted2)}
.lead-card:hover{border-color:rgba(240,192,64,.4);transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,0,0,.4)}
.lc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.lc-empresa{font-weight:700;font-size:14px;line-height:1.2}
.lc-contacto{font-size:12px;color:var(--muted);margin-top:2px}
.lc-cargo{font-size:11px;color:var(--muted2);margin-top:1px}
.lc-contacts{display:flex;gap:6px;margin:8px 0;flex-wrap:wrap}
.lc-badge{font-family:'IBM Plex Mono',monospace;font-size:10px;padding:3px 7px;border-radius:5px}
.badge-wpp{background:rgba(61,186,122,.15);color:var(--green);border:1px solid rgba(61,186,122,.2)}
.badge-mail{background:rgba(240,192,64,.12);color:var(--gold);border:1px solid rgba(240,192,64,.2)}
.badge-li{background:rgba(77,143,212,.12);color:var(--blue);border:1px solid rgba(77,143,212,.2)}
.lc-paso{font-size:11px;color:var(--muted);line-height:1.5;margin-top:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.lc-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
.lc-fecha{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted2)}
.hist-count{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--purple);background:var(--purplebg);border:1px solid rgba(155,114,224,.2);padding:2px 7px;border-radius:10px}

/* CHIPS */
.chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:600;font-family:'IBM Plex Mono',monospace;white-space:nowrap}
.chip-red{background:var(--redbg);color:var(--red);border:1px solid rgba(224,85,85,.3)}
.chip-orange{background:var(--orangebg);color:var(--orange);border:1px solid rgba(232,140,48,.3)}
.chip-green{background:var(--greenbg);color:var(--green);border:1px solid rgba(61,186,122,.3)}
.chip-blue{background:var(--bluebg);color:var(--blue);border:1px solid rgba(77,143,212,.3)}
.chip-gold{background:var(--goldbg);color:var(--gold);border:1px solid rgba(240,192,64,.3)}
.chip-purple{background:var(--purplebg);color:var(--purple);border:1px solid rgba(155,114,224,.3)}
.chip-muted{background:var(--s3);color:var(--muted);border:1px solid var(--border)}

/* BTNS */
.btn{padding:9px 16px;border-radius:8px;font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;border:none;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--gold);color:#0a0a0b}
.btn-primary:hover{background:#f8d060;transform:translateY(-1px)}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-ghost:hover{border-color:var(--muted);color:var(--text)}
.btn-green{background:var(--green);color:#0a0a0b}
.btn-green:hover{background:#55d490}
.btn-purple{background:var(--purple);color:#fff}
.btn-purple:hover{background:#b090f0}
.btn-sm{padding:5px 11px;font-size:11px}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important}

/* INPUTS */
.field{display:flex;flex-direction:column;gap:5px}
.field label{font-size:11px;color:var(--muted);font-weight:600;letter-spacing:.4px}
.field input,.field textarea,.field select{background:var(--s2);border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:8px;font-family:'Syne',sans-serif;font-size:13px;outline:none;transition:border-color .15s;resize:vertical}
.field input::placeholder,.field textarea::placeholder{color:var(--muted2)}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--gold)}
.field select option{background:var(--s2)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.full{grid-column:1/-1}

/* AI BLOCK */
.ai-block{background:var(--s2);border:1px solid rgba(155,114,224,.3);border-radius:10px;overflow:hidden}
.ai-block-header{padding:10px 14px;background:var(--purplebg);display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(155,114,224,.2)}
.ai-block-label{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--purple);letter-spacing:1px}
.ai-pulse{width:6px;height:6px;border-radius:50%;background:var(--purple);animation:pulse 1.4s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.2}}
.ai-block-body{padding:14px;font-size:13px;line-height:1.8;color:var(--text);white-space:pre-wrap}

/* HISTORIAL */
.hist-item{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:12px;position:relative}
.hist-item.comercial{border-left:3px solid var(--blue)}
.hist-item.cliente{border-left:3px solid var(--green)}
.hist-item.nota{border-left:3px solid var(--gold)}
.hist-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.hist-tipo{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:.8px;text-transform:uppercase}
.hist-fecha{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted)}
.hist-contenido{font-size:12px;line-height:1.6;white-space:pre-wrap;color:var(--text)}
.hist-quien{font-size:10px;font-weight:700;margin-bottom:3px}

/* LOADER */
.loader{display:none;align-items:center;gap:10px;padding:14px;color:var(--muted);font-size:12px}
.loader.on{display:flex}
.dots span{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--gold);animation:bounce 1.1s infinite;margin:0 2px}
.dots span:nth-child(2){animation-delay:.2s}
.dots span:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.3}40%{transform:translateY(-6px);opacity:1}}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:100;display:none;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto}
.modal-overlay.open{display:flex}
.modal{background:var(--s1);border:1px solid var(--border);border-radius:14px;width:100%;max-width:700px;margin:auto}
.modal-header{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;background:var(--s2);border-radius:14px 14px 0 0}
.modal-close{background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;line-height:1;padding:0 4px;flex-shrink:0}
.modal-close:hover{color:var(--text)}

/* PERFIL MODAL espec√≠fico */
.perfil-section{padding:16px 22px;border-bottom:1px solid var(--border)}
.perfil-section:last-child{border-bottom:none}
.section-label{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1.2px;text-transform:uppercase;margin-bottom:10px}

/* COPY BTN */
.copy-btn{background:var(--s3);border:1px solid var(--border);color:var(--muted);padding:4px 9px;border-radius:6px;cursor:pointer;font-size:10px;font-family:'IBM Plex Mono',monospace;transition:all .15s}
.copy-btn:hover{border-color:var(--gold);color:var(--gold)}

/* CANAL SELECTOR */
.canal-row{display:flex;gap:6px;flex-wrap:wrap}
.canal-opt{padding:6px 13px;border-radius:7px;border:1px solid var(--border);background:var(--s2);color:var(--muted);font-size:11px;font-family:'Syne',sans-serif;font-weight:600;cursor:pointer;transition:all .15s}
.canal-opt:hover{color:var(--text)}
.canal-opt.active.wpp{border-color:var(--green);color:var(--green);background:var(--greenbg)}
.canal-opt.active.mail{border-color:var(--gold);color:var(--gold);background:var(--goldbg)}
.canal-opt.active.li{border-color:var(--blue);color:var(--blue);background:var(--bluebg)}

/* SETUP */
.setup-overlay{position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px}
.setup-box{background:var(--s1);border:1px solid var(--border);border-radius:16px;padding:36px;max-width:420px;width:100%;text-align:center}
.setup-title{font-family:'Playfair Display',serif;font-size:26px;color:var(--gold);margin-bottom:6px}
.setup-sub{color:var(--muted);font-size:13px;line-height:1.6;margin-bottom:24px}
.setup-input{background:var(--s2);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:8px;font-family:'IBM Plex Mono',monospace;font-size:12px;width:100%;outline:none;margin-bottom:10px;transition:border-color .15s}
.setup-input:focus{border-color:var(--gold)}

/* NOTIFY */
.notify{position:fixed;bottom:20px;right:20px;background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:11px 16px;font-size:12px;z-index:300;transform:translateY(80px);opacity:0;transition:all .25s;max-width:300px}
.notify.show{transform:translateY(0);opacity:1}
.notify.success{border-color:rgba(61,186,122,.4);color:var(--green)}
.notify.error{border-color:rgba(224,85,85,.4);color:var(--red)}

/* VISTAGE TABLE */
.vtable{width:100%;border-collapse:collapse}
.vtable th{background:var(--s2);padding:9px 14px;text-align:left;font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid var(--border)}
.vtable td{padding:11px 14px;border-bottom:1px solid var(--border);font-size:12px;vertical-align:middle}
.vtable tr:last-child td{border-bottom:none}
.vtable tr{cursor:pointer;transition:background .1s}
.vtable tr:hover td{background:rgba(255,255,255,.025)}

/* SCROLL */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}

/* DRAG */
.lead-pill[draggable]{cursor:grab}
.lead-pill[draggable]:active{cursor:grabbing}
.week-col.drag-over{background:rgba(240,192,64,.08)!important;border-color:rgba(240,192,64,.4)!important;transition:all .1s}
.lead-pill.dragging{opacity:.3;transform:rotate(1deg)}

/* EMPTY */
.empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
.empty-icon{font-size:32px;margin-bottom:10px}

/* CARD HEADER */
.card{background:var(--s1);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.card-header{padding:13px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--s2)}
.card-title{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1.2px;text-transform:uppercase;display:flex;align-items:center;gap:8px}
.card-title::before{content:'';width:5px;height:5px;border-radius:50%;background:var(--gold)}
.card-body{padding:18px}
</style>
</head>
<body>

<!-- SETUP -->
<div class="setup-overlay" id="setupOverlay">
  <div class="setup-box">
    <div class="setup-title">Enfoco CRM</div>
    <div class="setup-sub">Ingres√° tu API Key de Anthropic para comenzar.<br>La pod√©s obtener en console.anthropic.com</div>
    <input class="setup-input" type="password" id="setupKey" placeholder="sk-ant-api03-..." />
    <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px" onclick="saveSetup()">Comenzar ‚Üí</button>
  </div>
</div>

<!-- APP SHELL -->
<div class="shell" id="mainShell" style="display:none">
  <aside class="sidebar">
    <div class="logo-block">
      <div class="logo-name">Enfoco Films</div>
      <div class="logo-tag">CRM Comercial</div>
    </div>
    <nav class="nav">
      <button class="nav-item active" onclick="showPanel('semana',this)"><span class="ni">üìÖ</span> Plan Semanal</button>
      <button class="nav-item" onclick="showPanel('leads',this)"><span class="ni">üíº</span> Leads 2026</button>
      <button class="nav-item" onclick="showPanel('vistage',this)"><span class="ni">üèÜ</span> Vistage 2026</button>
      <div class="nav-sep"></div>
      <button class="nav-item" onclick="showPanel('cargar',this)"><span class="ni">‚ûï</span> Cargar Vistage</button>
      <button class="nav-item" onclick="showPanel('config',this)"><span class="ni">‚öôÔ∏è</span> Configuraci√≥n</button>
    </nav>
    <div class="sidebar-footer">
      <span class="api-dot ok" id="apiDot"></span>
      <span class="api-status-text" id="apiStatus">API conectada</span>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="page-title" id="pageTitle">Plan <em>Semanal</em></div>
      <div class="topbar-right">
        <button class="btn btn-ghost btn-sm" style="font-size:11px;font-family:'IBM Plex Mono',monospace" onclick="loadSheetData()">‚ü≥ Sync</button>
      </div>
    </div>

    <div class="content">

      <!-- ‚ïê‚ïê PANEL SEMANA ‚ïê‚ïê -->
      <div class="panel active" id="panel-semana">
        <div class="search-bar"><input type="text" placeholder="Buscar empresa o contacto..." oninput="filtrarSemana(this.value)" /></div>
        <div id="semanaWrapper"></div>
      </div>

      <!-- ‚ïê‚ïê PANEL LEADS ‚ïê‚ïê -->
      <div class="panel" id="panel-leads">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="search-bar" style="flex:1;margin-bottom:0"><input type="text" placeholder="Buscar empresa o contacto..." oninput="filtrarLeads(this.value)" /></div>
          <button class="btn btn-primary btn-sm" onclick="openModal('modalNuevoLead')">+ Nuevo lead</button>
        </div>
        <div class="leads-grid" id="leadsGrid"></div>
      </div>

      <!-- ‚ïê‚ïê PANEL VISTAGE ‚ïê‚ïê -->
      <div class="panel" id="panel-vistage">
        <div class="search-bar"><input type="text" placeholder="Buscar nombre o compa√±√≠a..." oninput="filtrarVistage(this.value)" /></div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">Vistage 2026 ‚Äî Contactados por LinkedIn</div>
          </div>
          <div style="overflow-x:auto">
            <table class="vtable" id="vistageTable">
              <thead><tr>
                <th>Nombre / Compa√±√≠a</th><th>Rubro</th><th>Estado</th><th>√öltimo contacto</th><th>Acci√≥n</th>
              </tr></thead>
              <tbody id="vistageBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê PANEL CARGAR VISTAGE ‚ïê‚ïê -->
      <div class="panel" id="panel-cargar">
        <div class="card">
          <div class="card-header"><div class="card-title">Cargar desde LinkedIn</div></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:12px">
            <div class="field">
              <label>Texto del perfil de LinkedIn (copi√° nombre, cargo, empresa, descripci√≥n)</label>
              <textarea id="liTexto" rows="5" placeholder="Peg√° ac√° cualquier info del perfil: nombre, cargo, empresa, descripci√≥n..."></textarea>
            </div>
            <div class="form-grid">
              <div class="field"><label>Rubro (opcional)</label><input type="text" id="liRubro" placeholder="Alimentos, Automotriz..." /></div>
              <div class="field"><label>URL LinkedIn (opcional)</label><input type="text" id="liUrl" placeholder="https://linkedin.com/in/..." /></div>
            </div>
            <button class="btn btn-primary" style="align-self:flex-start" onclick="analizarLinkedIn()">ü§ñ Analizar y cargar</button>
            <div class="loader" id="loaderLi"><div class="dots"><span></span><span></span><span></span></div> Analizando perfil...</div>
            <div id="liFormContainer" style="display:none;flex-direction:column;gap:10px">
              <div class="section-label">Confirm√° los datos</div>
              <div class="form-grid">
                <div class="field"><label>Nombre</label><input type="text" id="vi_nombre" /></div>
                <div class="field"><label>Compa√±√≠a</label><input type="text" id="vi_company" /></div>
                <div class="field"><label>Cargo</label><input type="text" id="vi_cargo" /></div>
                <div class="field"><label>Rubro</label><input type="text" id="vi_rubro" /></div>
                <div class="field full"><label>Primer mensaje sugerido</label><textarea id="vi_msg" rows="4"></textarea></div>
              </div>
              <button class="btn btn-green" style="align-self:flex-start" onclick="guardarVistage()">‚úì Guardar en Vistage 2026</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê PANEL CONFIG ‚ïê‚ïê -->
      <div class="panel" id="panel-config">
        <div class="card">
          <div class="card-header"><div class="card-title">Configuraci√≥n</div></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:14px">
            <div class="field">
              <label>URL del Google Apps Script (para escribir en el Sheets)</label>
              <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/..." />
            </div>
            <button class="btn btn-primary btn-sm" style="align-self:flex-start" onclick="saveScriptUrl()">Guardar URL</button>
            <div id="scriptStatus" style="font-size:12px;color:var(--muted)"></div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </main>
</div><!-- /shell -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MODAL: PERFIL DEL LEAD                    -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modalPerfil">
  <div class="modal" style="max-width:720px">
    <div class="modal-header">
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="font-family:'Playfair Display',serif;font-size:20px" id="pf_titulo">‚Äî</div>
          <div id="pf_estado_chip"></div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:3px" id="pf_subtitulo"></div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap" id="pf_badges"></div>
      </div>
      <button class="modal-close" onclick="closeModal('modalPerfil')">√ó</button>
    </div>

    <!-- SECCI√ìN: CONTROLES DE FECHA/ESTADO -->
    <div class="perfil-section" style="background:var(--s2);display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <div style="font-size:11px;color:var(--muted)">Pr√≥xima acci√≥n:</div>
      <input type="date" id="pf_fecha" style="background:var(--s3);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-family:monospace;font-size:12px;outline:none;cursor:pointer" />
      <select id="pf_semaforo" style="background:var(--s3);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-family:'Syne',sans-serif;font-size:12px;outline:none">
        <option value="üî¥ Vencido">üî¥ Urgente</option>
        <option value="üü° Hoy">üü° Esta semana</option>
        <option value="üü¢ Ok">üü¢ Al d√≠a</option>
      </select>
      <select id="pf_estado" style="background:var(--s3);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-family:'Syne',sans-serif;font-size:12px;outline:none">
        <option value="1 - Nuevo">1 - Nuevo</option>
        <option value="2 - Enviado">2 - Enviado</option>
        <option value="6 - Proyecto En Tratativa">En Tratativa</option>
        <option value="3 - En Pausa">En Pausa</option>
        <option value="0 - Perdido">Perdido</option>
      </select>
      <button class="btn btn-green btn-sm" onclick="guardarCambiosLead()">‚úì Guardar</button>
    </div>

    <!-- SECCI√ìN: CONTEXTO AI -->
    <div class="perfil-section" id="pf_ai_section">
      <div class="section-label">Sugerencia IA</div>
      <div class="loader" id="loaderAI"><div class="dots"><span></span><span></span><span></span></div> Analizando historial...</div>
      <div class="ai-block" id="pf_ai_block" style="display:none">
        <div class="ai-block-header">
          <div class="ai-pulse"></div>
          <div class="ai-block-label">Contexto + recomendaci√≥n</div>
        </div>
        <div class="ai-block-body" id="pf_ai_body" style="border-bottom:1px solid rgba(155,114,224,.15)"></div>
        <div style="padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--purple);letter-spacing:1px">MENSAJE SUGERIDO</div>
          <button class="copy-btn" onclick="copiarMensajeAI()" style="border-color:rgba(155,114,224,.4);color:var(--purple)">üìã Copiar mensaje</button>
        </div>
        <div class="ai-block-body" id="pf_ai_msg" style="padding-top:0;color:var(--text);background:rgba(155,114,224,.05)"></div>
      </div>
    </div>

    <!-- SECCI√ìN: ACCIONES -->
    <div class="perfil-section" style="background:var(--s2)">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-primary btn-sm" onclick="toggleResponder()">‚úâÔ∏è Responder ahora</button>
        <button class="btn btn-ghost btn-sm" onclick="toggleNota()">üìù Agregar nota</button>
        <button class="btn btn-ghost btn-sm" onclick="refreshAI()">ü§ñ Re-analizar</button>
      </div>

      <!-- GENERADOR DE MENSAJE (dentro del perfil) -->
      <div id="pf_responder" style="display:none;margin-top:14px;display:none;flex-direction:column;gap:10px">
        <div class="canal-row" id="pf_canal_row">
          <button class="canal-opt wpp active" onclick="selectCanal('wpp',this)">üí¨ WhatsApp</button>
          <button class="canal-opt li" onclick="selectCanal('li',this)">üíº LinkedIn</button>
          <button class="canal-opt mail" onclick="selectCanal('mail',this)">üìß Email</button>
        </div>
        <select id="pf_msg_tipo" style="background:var(--s2);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:7px;font-size:12px;outline:none;font-family:'Syne',sans-serif">
          <option value="seguimiento al historial de conversaci√≥n">Seguimiento (basado en historial)</option>
          <option value="primer contacto fr√≠o">Primer contacto</option>
          <option value="respuesta a lo que me dijeron">Responder mensaje recibido</option>
          <option value="propuesta concreta">Propuesta / Cierre</option>
        </select>
        <div class="field">
          <label>Contexto extra (peg√° lo que te respondieron, algo nuevo...)</label>
          <textarea id="pf_msg_ctx" rows="3" placeholder="Opcional ‚Äî peg√° respuesta recibida o info nueva"></textarea>
        </div>
        <button class="btn btn-primary btn-sm" style="align-self:flex-start" onclick="generarMensajePerfil()">‚ú® Generar mensaje</button>
        <div class="loader" id="loaderMsg"><div class="dots"><span></span><span></span><span></span></div> Generando...</div>
        <div class="ai-block" id="pf_msg_block" style="display:none">
          <div class="ai-block-header">
            <div class="ai-pulse"></div>
            <div class="ai-block-label">Mensaje listo</div>
            <div style="margin-left:auto;display:flex;gap:6px">
              <button class="copy-btn" onclick="copyElText('pf_msg_body')">üìã Copiar</button>
            </div>
          </div>
          <div class="ai-block-body" id="pf_msg_body"></div>
        </div>
        <div id="pf_msg_post" style="display:none">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:4px">
            <span style="font-size:11px;color:var(--muted)">Pr√≥ximo seguimiento:</span>
            <select id="pf_dias" style="background:var(--s2);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:7px;font-size:12px;outline:none;font-family:'Syne',sans-serif">
              <option value="2">2 d√≠as</option>
              <option value="3" selected>3 d√≠as</option>
              <option value="5">5 d√≠as</option>
              <option value="7">7 d√≠as</option>
              <option value="14">14 d√≠as</option>
            </select>
            <button class="btn btn-green btn-sm" onclick="confirmarEnvio()">‚úì Enviado ‚Äî registrar</button>
          </div>
        </div>
      </div>

      <!-- NOTA R√ÅPIDA -->
      <div id="pf_nota" style="display:none;margin-top:14px;flex-direction:column;gap:8px">
        <div style="display:flex;gap:6px">
          <select id="nt_tipo" style="background:var(--s2);border:1px solid var(--border);color:var(--text);padding:7px 10px;border-radius:7px;font-size:12px;outline:none">
            <option value="cliente">üí¨ Respondi√≥ el cliente</option>
            <option value="comercial">‚úâÔ∏è Enviamos mensaje</option>
            <option value="nota">üìù Nota interna</option>
          </select>
          <select id="nt_canal" style="background:var(--s2);border:1px solid var(--border);color:var(--text);padding:7px 10px;border-radius:7px;font-size:12px;outline:none">
            <option value="wpp">WhatsApp</option>
            <option value="linkedin">LinkedIn</option>
            <option value="mail">Email</option>
            <option value="reunion">Reuni√≥n</option>
            <option value="nota">Nota</option>
          </select>
        </div>
        <textarea id="nt_contenido" rows="3" placeholder="Peg√° la conversaci√≥n o escrib√≠ una nota..." style="background:var(--s2);border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:8px;font-size:12px;outline:none;resize:vertical;font-family:'Syne',sans-serif"></textarea>
        <button class="btn btn-primary btn-sm" style="align-self:flex-start" onclick="guardarNota()">+ Guardar</button>
      </div>
    </div>

    <!-- SECCI√ìN: HISTORIAL -->
    <div class="perfil-section">
      <div class="section-label">Historial de conversaciones</div>
      <div id="pf_historial" style="display:flex;flex-direction:column;gap:8px;max-height:320px;overflow-y:auto"></div>
    </div>

  </div><!-- /modal -->
</div>

<!-- MODAL: NUEVO LEAD -->
<div class="modal-overlay" id="modalNuevoLead">
  <div class="modal" style="max-width:560px">
    <div class="modal-header">
      <div style="font-family:'Playfair Display',serif;font-size:18px">Nuevo Lead</div>
      <button class="modal-close" onclick="closeModal('modalNuevoLead')">√ó</button>
    </div>
    <div style="padding:20px;display:flex;flex-direction:column;gap:12px">
      <div class="form-grid">
        <div class="field"><label>Empresa</label><input type="text" id="nl_empresa" /></div>
        <div class="field"><label>Contacto</label><input type="text" id="nl_contacto" /></div>
        <div class="field"><label>Cargo</label><input type="text" id="nl_cargo" /></div>
        <div class="field"><label>Rubro</label><input type="text" id="nl_rubro" /></div>
        <div class="field"><label>WhatsApp</label><input type="text" id="nl_wpp" /></div>
        <div class="field"><label>Email</label><input type="text" id="nl_mail" /></div>
        <div class="field"><label>Origen</label>
          <select id="nl_origen"><option>Vistage</option><option>LinkedIn</option><option>Referido</option><option>Expo/Feria</option></select>
        </div>
        <div class="field"><label>Estado</label>
          <select id="nl_estado"><option value="1 - Nuevo">1 - Nuevo</option><option value="2 - Enviado">2 - Enviado</option></select>
        </div>
        <div class="field full"><label>Pr√≥ximo paso / notas</label><textarea id="nl_paso" rows="2"></textarea></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('modalNuevoLead')">Cancelar</button>
        <button class="btn btn-primary btn-sm" onclick="guardarNuevoLead()">Guardar lead</button>
      </div>
    </div>
  </div>
</div>

<div class="notify" id="notify"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG & ESTADO GLOBAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LEADS_CSV   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSROJCqfeSILX3MWmwvpS6dcUKqWqP580naRZu_CjpVijSUSqZfre59Id0TQyyfOQ/pub?output=csv&gid=1488122141';
const VISTAGE_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSROJCqfeSILX3MWmwvpS6dcUKqWqP580naRZu_CjpVijSUSqZfre59Id0TQyyfOQ/pub?output=csv&gid=530322819';

const ENFOCO_CTX = `Sos el asistente comercial de Enfoco Films, productora audiovisual de Buenos Aires.
SERVICIOS: video corporativo/institucional, streaming de eventos, publicidad, fotograf√≠a, animaci√≥n.
DIRECTOR: Dami Guelman, miembro Vistage G-308.
CLIENTES REF: GS1, INTA, Amcor, Essilor Luxottica, BAT, CPACF.
TONO: cercano, directo, argentino. Hablar de igual a igual. Sin protocolo.
CANAL PREFERIDO: WhatsApp. Si no hay n√∫mero ‚Üí LinkedIn con objetivo de conseguir WPP.
REGLAS: mencionar Vistage G-308 en primer contacto. M√°x 5 l√≠neas WPP/LinkedIn. Terminar con UNA sola pregunta.`;

let API_KEY = '';
let SCRIPT_URL = '';
let selectedCanal = 'wpp';
let currentPerfilKey = null;
let semanaOffset = 0; // 0 = semana actual, 1 = pr√≥xima, -1 = anterior
let draggedLeadKey = null;

// Store de leads en memoria (clave ‚Üí objeto lead enriquecido)
const store = {};
let storeIdx = 0;

function setLead(obj) {
  // Si ya existe por empresa, actualizar
  const existingKey = Object.keys(store).find(k => store[k].empresa === obj.empresa);
  if (existingKey) {
    // Preservar historial existente
    const hist = store[existingKey].historial || [];
    store[existingKey] = { ...store[existingKey], ...obj, historial: hist };
    return existingKey;
  }
  const k = 'l' + (storeIdx++);
  // Cargar historial de localStorage
  obj.historial = cargarHistorialLocal(obj.empresa);
  store[k] = obj;
  return k;
}

function getLead(k) { return store[k] || null; }
function getAllLeads() { return Object.entries(store).map(([k,v]) => ({...v, _key:k})); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIAL LOCAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function histKey(empresa) {
  return 'hist_' + empresa.toLowerCase().replace(/[^a-z0-9]/g,'_');
}

function cargarHistorialLocal(empresa) {
  try { return JSON.parse(localStorage.getItem(histKey(empresa)) || '[]'); }
  catch { return []; }
}

function guardarHistorialLocal(empresa, historial) {
  localStorage.setItem(histKey(empresa), JSON.stringify(historial));
}

function agregarEntradaHistorial(empresa, entrada) {
  // entrada: { fecha, tipo (wpp|mail|linkedin|reunion|nota), contenido, quien (Comercial|Cliente) }
  const leads = getAllLeads();
  const lead = leads.find(l => l.empresa === empresa);
  if (!lead) return;
  const hist = lead.historial || [];
  hist.push({ ...entrada, fecha: entrada.fecha || new Date().toLocaleString('es-AR') });
  store[lead._key].historial = hist;
  guardarHistorialLocal(empresa, hist);
  // Sync Sheets si hay script
  if (SCRIPT_URL) {
    callScript('saveHistorial', { empresa, contacto: lead.contacto, entrada }).catch(() => {});
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveSetup() {
  const k = document.getElementById('setupKey').value.trim();
  if (!k.startsWith('sk-ant-')) { showNotify('La key debe empezar con sk-ant-', 'error'); return; }
  API_KEY = k;
  localStorage.setItem('ef_key', k);
  bootApp();
}

function checkSetup() {
  const k = localStorage.getItem('ef_key');
  if (k) { API_KEY = k; bootApp(); }
}

function bootApp() {
  document.getElementById('setupOverlay').style.display = 'none';
  document.getElementById('mainShell').style.display = 'grid';
  SCRIPT_URL = localStorage.getItem('ef_script_url') || '';
  if (SCRIPT_URL) document.getElementById('scriptUrl').value = SCRIPT_URL;
  loadSheetData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARGA DE DATOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSheetData() {
  try {
    const [lr, vr] = await Promise.all([fetch(LEADS_CSV), fetch(VISTAGE_CSV)]);
    if (lr.ok) {
      const rows = parseCSV(await lr.text()).filter(r => {
        const e = (r[0]||'').trim();
        return e && e !== 'Empresa' && !e.startsWith('üíº') && !e.startsWith('üî•') && !e.startsWith('26/');
      });
      rows.forEach(r => {
        setLead({
          empresa:    r[0]||'', contacto: r[1]||'', cargo: r[2]||'',
          wpp:        r[3]||'', mail:     r[4]||'', medio: r[5]||'',
          rubro:      r[6]||'', estado:   r[8]||'',
          proxAccion: r[9]||'', semaforo: r[10]||'', proxPaso: r[11]||r[6]||'',
        });
      });
    }
    // Vistage: guardar por separado
    if (vr.ok) {
      const vrows = parseCSV(await vr.text()).filter(r => {
        const n = (r[2]||'').trim();
        return n && n !== 'Nombre' && n.length < 60 && !n.startsWith('üèÜ');
      });
      window._vistageRows = vrows;
    }
    renderAll();
    showNotify('Planilla sincronizada ‚úì', 'success');
  } catch(e) {
    loadFallback();
  }
}

function parseCSV(text) {
  return text.split('\n').map(line => {
    const row = []; let inQ = false, cur = '';
    for (const c of line) {
      if (c === '"') { inQ = !inQ; continue; }
      if (c === ',' && !inQ) { row.push(cur.trim()); cur = ''; continue; }
      cur += c;
    }
    row.push(cur.trim());
    return row;
  });
}

function loadFallback() {
  const fallback = [
    {empresa:'Dianddi Orax',contacto:'Axel Dillon',cargo:'',wpp:'11-6374-9826',mail:'',medio:'Vistage',rubro:'',estado:'2 - Enviado',proxAccion:hoy(0),semaforo:'üü° Hoy',proxPaso:'escribimos por wpp reunion semana de marzo'},
    {empresa:'LEFER SRL',contacto:'Fernando Morreale',cargo:'',wpp:'',mail:'fernandomorreale@hotmail.com',medio:'Vistage',rubro:'Automotriz',estado:'2 - Enviado',proxAccion:hoy(0),semaforo:'üü° Hoy',proxPaso:'LE MANDE POR LINKEDIN PARA REUNION'},
    {empresa:'Yellow & Co',contacto:'Vistoria Compagno',cargo:'',wpp:'',mail:'',medio:'Vistage',rubro:'',estado:'1 - Nuevo',proxAccion:hoy(0),semaforo:'üü° Hoy',proxPaso:'Nos respondio que nos escribe cuando necesite'},
    {empresa:'MC Servicios',contacto:'Cynthi Othatceguy',cargo:'',wpp:'',mail:'cynthia@mcservicios.org',medio:'Vistage',rubro:'',estado:'1 - Nuevo',proxAccion:hoy(0),semaforo:'üü° Hoy',proxPaso:'PEDIR REUNION PARA VIERNES POR LINKEDIN'},
    {empresa:'AWD Agency',contacto:'Juan Elliot',cargo:'',wpp:'',mail:'',medio:'Vistage',rubro:'Agencia',estado:'1 - Nuevo',proxAccion:hoy(0),semaforo:'üü° Hoy',proxPaso:'Coordinar por mail una reunion'},
    {empresa:'Bien Buenos Aires',contacto:'Nacho Perez Vidal',cargo:'',wpp:'',mail:'',medio:'Vistage',rubro:'Agencia',estado:'1 - Nuevo',proxAccion:hoy(0),semaforo:'üü° Hoy',proxPaso:'Coordinar por mail una reunion'},
    {empresa:'Rotundo Media',contacto:'Macarena Baez',cargo:'',wpp:'',mail:'',medio:'Vistage',rubro:'Agencia',estado:'1 - Nuevo',proxAccion:hoy(0),semaforo:'üü° Hoy',proxPaso:'Hacer seguimiento por Whatapp para reunion'},
    {empresa:'FontanaSisti',contacto:'Soledad Fontana',cargo:'',wpp:'',mail:'',medio:'Vistage',rubro:'Agencia',estado:'6 - Proyecto En Tratativa',proxAccion:hoy(6),semaforo:'üü¢ Ok',proxPaso:'REUNION 4-3-26'},
    {empresa:'TORKY',contacto:'Juan Ignacio Guajardo',cargo:'',wpp:'',mail:'torkymobility@gmail.com',medio:'Vistage',rubro:'',estado:'2 - Enviado',proxAccion:hoy(5),semaforo:'üü¢ Ok',proxPaso:'Le hice el seguimiento, si no responde bajarlo a 0%'},
    {empresa:'AUDIO BUENOS AIRES',contacto:'Leonardo Nadur',cargo:'',wpp:'',mail:'lnadur@buenosaires-sa.com.ar',medio:'Vistage',rubro:'',estado:'2 - Enviado',proxAccion:hoy(5),semaforo:'üü¢ Ok',proxPaso:'Le mande mail personalizado'},
    {empresa:'Siglo XXI Editores',contacto:'Sofia Miranda',cargo:'',wpp:'',mail:'',medio:'Feria del Libro',rubro:'Editorial',estado:'2 - Enviado',proxAccion:hoy(4),semaforo:'üü¢ Ok',proxPaso:'Marcelo Mingiano nos paso el contacto'},
    {empresa:'STARRETT',contacto:'Aurelio Soares',cargo:'',wpp:'',mail:'',medio:'Podcast',rubro:'Industrial',estado:'1 - Nuevo',proxAccion:hoy(3),semaforo:'üü¢ Ok',proxPaso:'Envie via Linkedin para 3D de Productos'},
    {empresa:'INTEGRALIM',contacto:'Bruno Sechet',cargo:'',wpp:'',mail:'',medio:'Podcast',rubro:'Alimentos',estado:'1 - Nuevo',proxAccion:hoy(3),semaforo:'üü¢ Ok',proxPaso:'Proponerle Podcast o Workshops'},
    {empresa:'VERALIMENT',contacto:'Andres Garcia',cargo:'',wpp:'',mail:'',medio:'Podcast',rubro:'Alimentos',estado:'1 - Nuevo',proxAccion:hoy(3),semaforo:'üü¢ Ok',proxPaso:'venderle tutorial, proponerle Podcast'},
    {empresa:'Fidegroup SA',contacto:'Federico Marini',cargo:'',wpp:'',mail:'',medio:'Vistage',rubro:'Alimentos',estado:'1 - Nuevo',proxAccion:hoy(19),semaforo:'üü¢ Ok',proxPaso:'Dijo que ahora no pero mas adelante reunirnos'},
  ];
  fallback.forEach(l => setLead(l));
  window._vistageRows = [];
  renderAll();
}

function hoy(addDays=0) {
  const d = new Date(); d.setDate(d.getDate()+addDays);
  return d.toISOString().split('T')[0];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER SEMANA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() {
  renderSemana();
  renderLeads();
  renderVistage();
}

function renderSemana(filtro='') {
  const wrapper = document.getElementById('semanaWrapper');
  const hoyDate = new Date(); hoyDate.setHours(0,0,0,0);

  // Calcular lunes de la semana con offset
  const dow = hoyDate.getDay();
  const lunes = new Date(hoyDate);
  lunes.setDate(hoyDate.getDate() - (dow === 0 ? 6 : dow - 1) + semanaOffset * 7);
  lunes.setHours(0,0,0,0);

  // Solo Lun‚ÄìVie (5 d√≠as)
  const DIAS = ['Lun','Mar','Mi√©','Jue','Vie'];
  const dias = Array.from({length:5}, (_,i) => {
    const d = new Date(lunes); d.setDate(lunes.getDate()+i); return d;
  });
  const viernes = dias[4];

  // Label de semana
  const lunesLabel = lunes.toLocaleDateString('es-AR',{day:'numeric',month:'short'});
  const viernesLabel = viernes.toLocaleDateString('es-AR',{day:'numeric',month:'short'});
  const esEstaSemana = semanaOffset === 0;

  // Agrupar leads
  const leads = getAllLeads().filter(l => !filtro || matchFiltro(l,filtro));
  const porDia = Array.from({length:5}, () => []);
  const sinFecha = [];
  const fuera = []; // antes o despu√©s de esta semana

  leads.forEach(lead => {
    const pa = parseFechaStr(lead.proxAccion);
    if (!pa) { sinFecha.push(lead); return; }
    pa.setHours(0,0,0,0);
    let colocado = false;
    for (let i=0; i<5; i++) {
      if (pa.getTime() === dias[i].getTime()) { porDia[i].push(lead); colocado=true; break; }
    }
    if (!colocado) sinFecha.push(lead);
  });

  let h = '';

  // Barra de navegaci√≥n
  h += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
    <button onclick="cambiarSemana(-1)" class="btn btn-ghost btn-sm" style="font-size:16px;padding:6px 12px">‚Äπ</button>
    <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:${esEstaSemana?'var(--gold)':'var(--muted)'};flex:1;text-align:center;letter-spacing:.5px">
      ${esEstaSemana ? '‚Äî SEMANA ACTUAL ‚Äî' : semanaOffset > 0 ? '‚Üí ' : '‚Üê '}
      ${lunesLabel} ‚Äì ${viernesLabel}
      ${esEstaSemana ? '' : semanaOffset > 0 ? '(pr√≥xima)' : '(anterior)'}
    </div>
    <button onclick="cambiarSemana(1)" class="btn btn-ghost btn-sm" style="font-size:16px;padding:6px 12px">‚Ä∫</button>
    ${!esEstaSemana ? `<button onclick="irSemanaActual()" class="btn btn-ghost btn-sm" style="font-size:10px;font-family:monospace">Hoy</button>` : ''}
  </div>`;

  // Headers
  h += `<div style="display:grid;grid-template-columns:repeat(5,1fr) 160px;gap:8px;margin-bottom:4px">`;
  dias.forEach((d,i) => {
    const esHoy = d.getTime() === hoyDate.getTime();
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    h += `<div class="week-day-label${esHoy?' today':''}">${DIAS[i]}<br><span style="font-size:11px">${dd}/${mm}</span></div>`;
  });
  h += `<div class="week-day-label" style="color:var(--muted2)">Sin fecha</div>`;
  h += `</div>`;

  // Grid
  h += `<div style="display:grid;grid-template-columns:repeat(5,1fr) 160px;gap:8px;align-items:start">`;

  // Columnas Lun‚ÄìVie
  dias.forEach((d,i) => {
    const esHoy = d.getTime() === hoyDate.getTime();
    const isoStr = d.toISOString().split('T')[0];
    h += `<div class="week-col${esHoy?' today-col':''}" 
      data-date="${isoStr}"
      ondragover="onDragOver(event,this)" 
      ondragleave="onDragLeave(this)"
      ondrop="onDrop(event,'${isoStr}')">`;
    if (!porDia[i].length) {
      h += `<div style="text-align:center;padding:16px 0;color:var(--muted2);font-size:10px;border:1px dashed var(--border);border-radius:6px;margin:2px">Libre</div>`;
    } else {
      porDia[i].forEach(lead => {
        const cls = semClass(lead.semaforo);
        h += `<div class="lead-pill ${cls}" 
          draggable="true"
          ondragstart="onDragStart(event,'${lead._key}')"
          ondragend="onDragEnd(event)"
          onclick="abrirPerfil('${lead._key}')">
          <div class="pill-empresa">${lead.empresa}</div>
          <div class="pill-contacto">${lead.contacto}</div>
          <div class="pill-canal" style="color:${canalColor(lead)}">${canalIcono(lead)}</div>
        </div>`;
      });
    }
    h += `</div>`;
  });

  // Columna "Sin fecha"
  h += `<div class="week-col" style="border-color:var(--muted2);border-style:dashed"
    ondragover="onDragOver(event,this)"
    ondragleave="onDragLeave(this)"
    ondrop="onDrop(event,'sin-fecha')">`;
  if (!sinFecha.length) {
    h += `<div style="text-align:center;padding:16px 0;color:var(--muted2);font-size:10px">‚Äî</div>`;
  } else {
    sinFecha.forEach(lead => {
      h += `<div class="lead-pill neutral" 
        draggable="true"
        ondragstart="onDragStart(event,'${lead._key}')"
        ondragend="onDragEnd(event)"
        onclick="abrirPerfil('${lead._key}')">
        <div class="pill-empresa">${lead.empresa}</div>
        <div class="pill-contacto">${lead.contacto}</div>
        <div class="pill-canal" style="color:var(--muted2)">Sin agenda</div>
      </div>`;
    });
  }
  h += `</div>`;

  h += `</div>`; // /grid
  wrapper.innerHTML = h;
}

function cambiarSemana(dir) { semanaOffset += dir; renderSemana(document.querySelector('#panel-semana .search-bar input')?.value||''); }
function irSemanaActual() { semanaOffset = 0; renderSemana(); }

// ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onDragStart(event, key) {
  draggedLeadKey = key;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.4';
}

function onDragEnd(event) {
  event.target.style.opacity = '1';
  draggedLeadKey = null;
}

function onDragOver(event, col) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  col.style.background = 'rgba(240,192,64,0.08)';
  col.style.borderColor = 'rgba(240,192,64,0.4)';
}

function onDragLeave(col) {
  col.style.background = '';
  col.style.borderColor = '';
}

function onDrop(event, fechaISO) {
  event.preventDefault();
  const col = event.currentTarget;
  col.style.background = ''; col.style.borderColor = '';

  if (!draggedLeadKey) return;
  const lead = getLead(draggedLeadKey);
  if (!lead) return;

  if (fechaISO === 'sin-fecha') {
    store[draggedLeadKey].proxAccion = '';
  } else {
    store[draggedLeadKey].proxAccion = fechaISO;
    // Actualizar sem√°foro autom√°ticamente
    const hoyD = new Date(); hoyD.setHours(0,0,0,0);
    const dropD = new Date(fechaISO); dropD.setHours(0,0,0,0);
    const diff = (dropD - hoyD) / 86400000;
    store[draggedLeadKey].semaforo = diff < 0 ? 'üî¥ Vencido' : diff <= 2 ? 'üü° Hoy' : 'üü¢ Ok';
  }

  // Sync Sheets si hay script
  if (SCRIPT_URL && fechaISO !== 'sin-fecha') {
    const [y,m,d] = fechaISO.split('-');
    callScript('updateLead', {
      empresa: lead.empresa,
      proxAccion: `${d}/${m}/${y}`,
      semaforo: store[draggedLeadKey].semaforo
    }).catch(()=>{});
  }

  showNotify(`${lead.empresa} ‚Üí ${fechaISO === 'sin-fecha' ? 'sin fecha' : new Date(fechaISO+'T12:00').toLocaleDateString('es-AR')}`, 'success');
  renderSemana(document.querySelector('#panel-semana .search-bar input')?.value||'');
  renderLeads();
}

function filtrarSemana(v) { renderSemana(v); }

function parseFechaStr(str) {
  if (!str) return null;
  str = str.trim();
  // YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}/.test(str)) return new Date(str.split(' ')[0]);
  // DD/MM/YYYY
  if (/^\d{2}\/\d{2}\/\d{4}/.test(str)) {
    const [d,m,y] = str.split('/'); return new Date(+y, +m-1, +d);
  }
  return null;
}

function semClass(sem) {
  if (!sem) return 'ok';
  if (sem.includes('üî¥') || sem.toLowerCase().includes('vencido')) return 'urgent';
  if (sem.includes('üü°') || sem.toLowerCase().includes('hoy')) return 'today-p';
  return 'ok';
}

function canalIcono(lead) {
  if (lead.wpp && lead.wpp !== 'nan') return 'üí¨ WPP';
  if (lead.mail && lead.mail !== 'nan') return 'üìß Mail';
  return 'üíº LinkedIn';
}

function canalColor(lead) {
  if (lead.wpp && lead.wpp !== 'nan') return 'var(--green)';
  if (lead.mail && lead.mail !== 'nan') return 'var(--gold)';
  return 'var(--blue)';
}

function matchFiltro(lead, filtro) {
  const f = filtro.toLowerCase();
  return (lead.empresa||'').toLowerCase().includes(f) || (lead.contacto||'').toLowerCase().includes(f);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER LEADS CARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLeads(filtro='') {
  const grid = document.getElementById('leadsGrid');
  const leads = getAllLeads().filter(l => !filtro || matchFiltro(l,filtro));

  if (!leads.length) {
    grid.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><div>Sin leads cargados</div></div>`;
    return;
  }

  // Ordenar: urgente > hoy > ok > sin sem√°foro
  const order = l => {
    const s = l.semaforo||'';
    if (s.includes('üî¥')) return 0;
    if (s.includes('üü°')) return 1;
    if (s.includes('üü¢')) return 2;
    return 3;
  };
  leads.sort((a,b) => order(a)-order(b));

  grid.innerHTML = leads.map(lead => {
    const cls = semClass(lead.semaforo);
    const clsMap = {urgent:'urgent', 'today-p':'today-c', ok:'ok'};
    const cardCls = clsMap[cls]||'neutral';
    const hist = lead.historial||[];
    const hasWpp = lead.wpp && lead.wpp !== 'nan';
    const hasMail = lead.mail && lead.mail !== 'nan';

    return `<div class="lead-card ${cardCls}" onclick="abrirPerfil('${lead._key}')">
      <div class="lc-top">
        <div>
          <div class="lc-empresa">${lead.empresa}</div>
          <div class="lc-contacto">${lead.contacto}</div>
          ${lead.cargo ? `<div class="lc-cargo">${lead.cargo}</div>` : ''}
        </div>
        ${estadoChip(lead.estado)}
      </div>
      <div class="lc-contacts">
        ${hasWpp  ? `<span class="lc-badge badge-wpp">üí¨ ${lead.wpp}</span>` : ''}
        ${hasMail ? `<span class="lc-badge badge-mail">üìß ${lead.mail}</span>` : ''}
        ${!hasWpp && !hasMail ? `<span class="lc-badge badge-li">üíº LinkedIn</span>` : ''}
      </div>
      ${lead.proxPaso ? `<div class="lc-paso">${lead.proxPaso}</div>` : ''}
      <div class="lc-bottom">
        <span class="lc-fecha">${formatFecha(lead.proxAccion)}</span>
        ${hist.length ? `<span class="hist-count">üìã ${hist.length} entradas</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

function filtrarLeads(v) { renderLeads(v); }

function formatFecha(str) {
  if (!str) return '‚Äî';
  const d = parseFechaStr(str);
  if (!d) return str;
  return d.toLocaleDateString('es-AR', {day:'2-digit',month:'2-digit',year:'numeric'});
}

function estadoChip(e) {
  if (!e) return '';
  if (e.includes('Tratativa')) return `<span class="chip chip-green">ü§ù</span>`;
  if (e.includes('Enviado'))   return `<span class="chip chip-gold">‚úâÔ∏è</span>`;
  if (e.includes('Nuevo'))     return `<span class="chip chip-blue">üÜï</span>`;
  if (e.includes('Pausa'))     return `<span class="chip chip-muted">‚è∏</span>`;
  if (e.includes('Perdido'))   return `<span class="chip chip-red">‚úó</span>`;
  return `<span class="chip chip-muted">${e.substring(0,8)}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER VISTAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderVistage(filtro='') {
  const tbody = document.getElementById('vistageBody');
  const rows = (window._vistageRows||[]).filter(r => {
    if (!filtro) return true;
    const f = filtro.toLowerCase();
    return (r[0]||'').toLowerCase().includes(f) || (r[2]||'').toLowerCase().includes(f);
  });

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:28px;color:var(--muted)">Sin datos Vistage</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => `<tr onclick="abrirPerfilVistage(${JSON.stringify([r[0],r[2],r[4],r[5],r[6]]).replace(/"/g,'&quot;')})">
    <td>
      <div style="font-weight:700;font-size:13px">${r[2]||''}</div>
      <div style="font-size:11px;color:var(--muted)">${r[0]||''}</div>
    </td>
    <td style="font-size:12px;color:var(--muted)">${r[4]||'‚Äî'}</td>
    <td>${estadoChip(r[5]||'')}</td>
    <td style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted)">${(r[6]||'').split(' ')[0]||'‚Äî'}</td>
    <td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();moverALeads('${encodeURIComponent(r[0]||'')}','${encodeURIComponent(r[2]||'')}','${encodeURIComponent(r[4]||'')}')">‚Üí A Leads</button></td>
  </tr>`).join('');
}

function filtrarVistage(v) { renderVistage(v); }

function abrirPerfilVistage(data) {
  const [company, nombre, rubro, estado, ultimoContacto] = data;
  const key = setLead({
    empresa: company || nombre,
    contacto: nombre,
    cargo: '', wpp:'', mail:'', medio:'Vistage', rubro,
    estado: estado||'0 - Enviado Linkedin',
    proxAccion:'', semaforo:'üü¢ Ok', proxPaso:''
  });
  abrirPerfil(key);
}

function moverALeads(companyEnc, nombreEnc, rubroEnc) {
  const company = decodeURIComponent(companyEnc);
  const nombre  = decodeURIComponent(nombreEnc);
  const rubro   = decodeURIComponent(rubroEnc);
  const key = setLead({
    empresa: company||nombre, contacto: nombre,
    cargo:'', wpp:'', mail:'', medio:'Vistage', rubro,
    estado:'1 - Nuevo', proxAccion: hoy(0), semaforo:'üü° Hoy', proxPaso:'Respondi√≥ en Vistage'
  });
  renderLeads();
  showNotify(`${nombre} movido a Leads ‚úì`, 'success');
  abrirPerfil(key);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERFIL DEL LEAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function abrirPerfil(key) {
  const lead = getLead(key);
  if (!lead) return;
  currentPerfilKey = key;

  // Header
  document.getElementById('pf_titulo').textContent = lead.empresa;
  document.getElementById('pf_subtitulo').textContent =
    [lead.contacto, lead.cargo, lead.rubro].filter(Boolean).join(' ¬∑ ');
  document.getElementById('pf_estado_chip').innerHTML = estadoChipFull(lead.estado);

  // Badges de contacto
  const hasWpp  = lead.wpp && lead.wpp !== 'nan';
  const hasMail = lead.mail && lead.mail !== 'nan';
  document.getElementById('pf_badges').innerHTML = [
    hasWpp  ? `<span class="lc-badge badge-wpp">üí¨ ${lead.wpp}</span>` : '',
    hasMail ? `<span class="lc-badge badge-mail">üìß ${lead.mail}</span>` : '',
    !hasWpp&&!hasMail ? `<span class="lc-badge badge-li">üíº Solo LinkedIn</span>` : '',
    lead.medio ? `<span class="lc-badge" style="background:var(--s3);color:var(--muted);border:1px solid var(--border)">üìå ${lead.medio}</span>` : '',
  ].join('');

  // Fecha ‚Äî sugerir +3 d√≠as si est√° vac√≠a
  let fechaISO = '';
  if (lead.proxAccion) {
    const d = parseFechaStr(lead.proxAccion);
    if (d) fechaISO = d.toISOString().split('T')[0];
  }
  if (!fechaISO) {
    // Sugerir +3 d√≠as
    const sugerida = new Date(); sugerida.setDate(sugerida.getDate()+3);
    fechaISO = sugerida.toISOString().split('T')[0];
  }
  document.getElementById('pf_fecha').value = fechaISO;

  // Sem√°foro y estado
  const semSel = document.getElementById('pf_semaforo');
  if (lead.semaforo?.includes('üî¥')) semSel.value = 'üî¥ Vencido';
  else if (lead.semaforo?.includes('üü°')) semSel.value = 'üü° Hoy';
  else semSel.value = 'üü¢ Ok';

  const estSel = document.getElementById('pf_estado');
  const estados = ['1 - Nuevo','2 - Enviado','6 - Proyecto En Tratativa','3 - En Pausa','0 - Perdido'];
  const estMatch = estados.find(e => lead.estado && lead.estado.includes(e.split(' - ')[1]?.split(' ')[0]||'X'));
  if (lead.estado) {
    // Match por valor exacto o parcial
    const opt = Array.from(estSel.options).find(o => lead.estado.includes(o.value.split(' - ')[1]?.split(' ')[0]||'XXX'));
    if (opt) estSel.value = opt.value; else estSel.value = '1 - Nuevo';
  }

  // Auto-seleccionar canal
  if (hasWpp) selectCanal('wpp', document.querySelector('.canal-opt.wpp'));
  else if (hasMail) selectCanal('mail', document.querySelector('.canal-opt.mail'));
  else selectCanal('li', document.querySelector('.canal-opt.li'));

  // Resetear secciones
  document.getElementById('pf_responder').style.display = 'none';
  document.getElementById('pf_nota').style.display = 'none';
  document.getElementById('pf_msg_block').style.display = 'none';
  document.getElementById('pf_msg_post').style.display = 'none';

  // Historial
  renderHistorialPerfil(lead);

  openModal('modalPerfil');

  // Generar sugerencia AI
  generarSugerenciaAI(lead);
}

function estadoChipFull(e) {
  if (!e) return '';
  if (e.includes('Tratativa')) return `<span class="chip chip-green">ü§ù En Tratativa</span>`;
  if (e.includes('Enviado'))   return `<span class="chip chip-gold">‚úâÔ∏è Enviado</span>`;
  if (e.includes('Nuevo'))     return `<span class="chip chip-blue">üÜï Nuevo</span>`;
  if (e.includes('Pausa'))     return `<span class="chip chip-muted">‚è∏ En Pausa</span>`;
  if (e.includes('Perdido'))   return `<span class="chip chip-red">‚úó Perdido</span>`;
  return `<span class="chip chip-muted">${e}</span>`;
}

function renderHistorialPerfil(lead) {
  const container = document.getElementById('pf_historial');
  const hist = lead.historial || [];
  if (!hist.length) {
    container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Sin historial. Registr√° la primera interacci√≥n.</div>`;
    return;
  }
  container.innerHTML = [...hist].reverse().map(h => {
    const isCliente = h.quien === 'Cliente';
    const isCom = h.quien === 'Comercial';
    const isNota = h.tipo === 'nota';
    const cls = isCliente ? 'cliente' : isCom ? 'comercial' : 'nota';
    const tipoLabel = {wpp:'üí¨ WhatsApp', mail:'üìß Email', linkedin:'üíº LinkedIn', reunion:'ü§ù Reuni√≥n', nota:'üìù Nota'}[h.tipo] || h.tipo;
    const colorTipo = {wpp:'var(--green)', mail:'var(--gold)', linkedin:'var(--blue)', reunion:'var(--purple)', nota:'var(--gold)'}[h.tipo] || 'var(--muted)';
    return `<div class="hist-item ${cls}">
      <div class="hist-meta">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="hist-tipo" style="color:${colorTipo}">${tipoLabel}</span>
          <span style="font-size:10px;font-weight:700;color:${isCliente?'var(--green)':isCom?'var(--blue)':'var(--muted)'}">${h.quien||''}</span>
        </div>
        <span class="hist-fecha">${h.fecha||''}</span>
      </div>
      <div class="hist-contenido">${h.contenido||''}</div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUGERENCIA AI (al abrir perfil)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generarSugerenciaAI(lead) {
  document.getElementById('pf_ai_block').style.display = 'none';
  document.getElementById('loaderAI').classList.add('on');

  const hist = (lead.historial||[]).slice(-3);
  const histText = hist.length
    ? hist.map(h => `[${h.quien||'?'} - ${h.tipo}] ${h.contenido}`).join('\n')
    : `√öltimo paso registrado: ${lead.proxPaso||'ninguno'}`;

  const fechaSugerida = (() => {
    const d = new Date(); d.setDate(d.getDate()+3);
    return d.toLocaleDateString('es-AR');
  })();

  const canal = (lead.wpp && lead.wpp!=='nan') ? 'WhatsApp' : (lead.mail && lead.mail!=='nan') ? 'email' : 'LinkedIn';

  const prompt = ENFOCO_CTX + `

LEAD: ${lead.empresa} / ${lead.contacto}
${lead.rubro ? `Rubro: ${lead.rubro}` : ''}
${lead.wpp && lead.wpp!=='nan' ? `WhatsApp: ${lead.wpp}` : lead.mail && lead.mail!=='nan' ? `Email: ${lead.mail}` : 'Solo LinkedIn'}
Estado: ${lead.estado||'‚Äî'}

√öLTIMAS INTERACCIONES:
${histText}

Respond√© en este formato EXACTO:
TEMA: [de qu√© vienen hablando, o qu√© propusimos ‚Äî 1 l√≠nea]
SUGERENCIA: [qu√© hacer ahora y por qu√© canal ‚Äî 1 l√≠nea]
CU√ÅNDO: [${fechaSugerida}]
MENSAJE:
[el mensaje listo para copiar y enviar por ${canal}, m√°x 5 l√≠neas, tono argentino directo]`;

  try {
    const r = await callClaude(prompt);
    // Separar contexto del mensaje
    const msgMatch = r.match(/MENSAJE:\s*([\s\S]+)/i);
    const contexto = msgMatch ? r.substring(0, r.indexOf(msgMatch[0])).trim() : r;
    const mensaje  = msgMatch ? msgMatch[1].trim() : '';
    document.getElementById('pf_ai_body').textContent = contexto;
    document.getElementById('pf_ai_msg').textContent  = mensaje;
    document.getElementById('pf_ai_block').style.display = 'block';
  } catch(e) {
    document.getElementById('pf_ai_body').textContent = 'Error: ' + e.message;
    document.getElementById('pf_ai_msg').textContent  = '';
    document.getElementById('pf_ai_block').style.display = 'block';
  } finally {
    document.getElementById('loaderAI').classList.remove('on');
  }
}

async function refreshAI() {
  const lead = getLead(currentPerfilKey);
  if (lead) generarSugerenciaAI(lead);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GENERADOR DE MENSAJE DENTRO DEL PERFIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleResponder() {
  const el = document.getElementById('pf_responder');
  const visible = el.style.display === 'flex';
  el.style.display = visible ? 'none' : 'flex';
  el.style.flexDirection = 'column';
  document.getElementById('pf_nota').style.display = 'none';
}

function toggleNota() {
  const el = document.getElementById('pf_nota');
  const visible = el.style.display === 'flex';
  el.style.display = visible ? 'none' : 'flex';
  el.style.flexDirection = 'column';
  document.getElementById('pf_responder').style.display = 'none';
}

async function generarMensajePerfil() {
  const lead = getLead(currentPerfilKey);
  if (!lead) return;

  const tipo = document.getElementById('pf_msg_tipo').value;
  const ctx  = document.getElementById('pf_msg_ctx').value.trim();
  const canalNombre = selectedCanal === 'wpp' ? 'WhatsApp' : selectedCanal === 'li' ? 'LinkedIn' : 'Email';

  const hist = (lead.historial||[]).slice(-3);
  const histText = hist.map(h => `[${h.quien} - ${h.tipo}]: ${h.contenido}`).join('\n') || lead.proxPaso || 'sin historial previo';

  const prompt = ENFOCO_CTX + `

Generame un mensaje de ${canalNombre} para:
Empresa: ${lead.empresa}
Contacto: ${lead.contacto}
${lead.cargo ? `Cargo: ${lead.cargo}` : ''}
${lead.rubro ? `Rubro: ${lead.rubro}` : ''}
Tipo: ${tipo}
${lead.wpp && lead.wpp!=='nan' ? `WhatsApp: ${lead.wpp}` : lead.mail && lead.mail!=='nan' ? `Email: ${lead.mail}` : 'Sin contacto directo ‚Äî solo LinkedIn'}

HISTORIAL RECIENTE:
${histText}
${ctx ? `\nINFO NUEVA / RESPUESTA RECIBIDA:\n${ctx}` : ''}

Escrib√≠ SOLO el mensaje listo para copiar. Sin comillas ni explicaciones previas.${canalNombre==='Email' ? ' Primera l√≠nea: Asunto: ...' : ''}`;

  document.getElementById('loaderMsg').classList.add('on');
  document.getElementById('pf_msg_block').style.display = 'none';
  document.getElementById('pf_msg_post').style.display = 'none';

  try {
    const r = await callClaude(prompt);
    document.getElementById('pf_msg_body').textContent = r;
    document.getElementById('pf_msg_block').style.display = 'block';
    document.getElementById('pf_msg_post').style.display = 'block';

    // Auto-guardar en historial como mensaje generado
    agregarEntradaHistorial(lead.empresa, {
      tipo: selectedCanal,
      quien: 'Comercial',
      contenido: `[GENERADO - sin confirmar env√≠o]\n${r}`
    });
  } catch(e) { showNotify('Error: ' + e.message, 'error'); }
  finally { document.getElementById('loaderMsg').classList.remove('on'); }
}

function confirmarEnvio() {
  const lead = getLead(currentPerfilKey);
  if (!lead) return;
  const dias = parseInt(document.getElementById('pf_dias').value);
  const nueva = new Date(); nueva.setDate(nueva.getDate()+dias);
  const fechaISO = nueva.toISOString().split('T')[0];
  const msg = document.getElementById('pf_msg_body').textContent;

  // Actualizar historial ‚Äî marcar como enviado
  const hist = lead.historial||[];
  // Reemplazar el √∫ltimo entry "GENERADO" con confirmado
  const lastIdx = hist.map(h=>h.contenido).lastIndexOf(hist.filter(h=>h.contenido?.startsWith('[GENERADO')).slice(-1)[0]?.contenido);
  if (lastIdx >= 0) {
    hist[lastIdx].contenido = msg;
    hist[lastIdx].quien = 'Comercial';
    guardarHistorialLocal(lead.empresa, hist);
  }

  // Actualizar fecha en store
  store[currentPerfilKey].proxAccion = fechaISO;

  // Sync Sheets
  if (SCRIPT_URL) {
    callScript('updateLead', {
      empresa: lead.empresa,
      proxAccion: nueva.toLocaleDateString('es-AR'),
      semaforo: 'üü¢ Ok',
    }).catch(()=>{});
  }

  document.getElementById('pf_msg_post').style.display = 'none';
  showNotify(`‚úì Registrado. Pr√≥ximo: ${nueva.toLocaleDateString('es-AR')}`, 'success');
  renderHistorialPerfil(getLead(currentPerfilKey));
  renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GUARDAR NOTA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function guardarNota() {
  const lead = getLead(currentPerfilKey);
  if (!lead) return;
  const tipo     = document.getElementById('nt_tipo').value; // cliente|comercial|nota
  const canal    = document.getElementById('nt_canal').value;
  const contenido= document.getElementById('nt_contenido').value.trim();
  if (!contenido) { showNotify('Escrib√≠ algo primero', 'error'); return; }

  const quien = tipo === 'cliente' ? 'Cliente' : tipo === 'comercial' ? 'Comercial' : 'Nota';
  agregarEntradaHistorial(lead.empresa, { tipo: canal, quien, contenido });

  document.getElementById('nt_contenido').value = '';
  renderHistorialPerfil(getLead(currentPerfilKey));
  renderLeads();
  renderSemana();
  showNotify('Guardado ‚úì', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GUARDAR CAMBIOS DEL LEAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function guardarCambiosLead() {
  const lead = getLead(currentPerfilKey);
  if (!lead) return;

  const fechaVal  = document.getElementById('pf_fecha').value;
  const semaforo  = document.getElementById('pf_semaforo').value;
  const estado    = document.getElementById('pf_estado').value;

  let fechaFmt = '';
  if (fechaVal) {
    const [y,m,d] = fechaVal.split('-');
    fechaFmt = `${d}/${m}/${y}`;
  }

  store[currentPerfilKey].proxAccion = fechaVal || lead.proxAccion;
  store[currentPerfilKey].semaforo   = semaforo;
  store[currentPerfilKey].estado     = estado;

  if (SCRIPT_URL) {
    try {
      await callScript('updateLead', { empresa: lead.empresa, proxAccion: fechaFmt, semaforo, estado });
      showNotify('‚úì Guardado en Sheets', 'success');
    } catch(e) {
      showNotify('Guardado local (Sheets: ' + e.message + ')', 'error');
    }
  } else {
    showNotify('‚úì Actualizado', 'success');
  }

  renderAll();
  closeModal('modalPerfil');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARGAR VISTAGE DESDE LINKEDIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function analizarLinkedIn() {
  const texto = document.getElementById('liTexto').value.trim();
  const rubro = document.getElementById('liRubro').value.trim();
  const url   = document.getElementById('liUrl').value.trim();
  if (!texto && !url) { showNotify('Peg√° texto del perfil o la URL', 'error'); return; }

  const prompt = ENFOCO_CTX + `

Perfil a analizar:
${texto || 'URL: ' + url}
Rubro adicional: ${rubro||'desconocido'}

Extra√© la info y gener√° un primer mensaje de LinkedIn.
Respond√© EXACTAMENTE en este formato:
NOMBRE: [nombre completo]
EMPRESA: [empresa]
CARGO: [cargo]
RUBRO: [rubro]
MENSAJE:
[mensaje de primer contacto, m√°x 5 l√≠neas, mencion√° Vistage G-308]`;

  document.getElementById('loaderLi').classList.add('on');
  document.getElementById('liFormContainer').style.display = 'none';

  try {
    const r = await callClaude(prompt);
    const get = (field) => (r.match(new RegExp(field+':\\s*(.+)','i'))||[])[1]?.trim()||'';
    const msgMatch = r.match(/MENSAJE:\s*([\s\S]+)/i);

    document.getElementById('vi_nombre').value  = get('NOMBRE');
    document.getElementById('vi_company').value = get('EMPRESA');
    document.getElementById('vi_cargo').value   = get('CARGO');
    document.getElementById('vi_rubro').value   = get('RUBRO') || rubro;
    document.getElementById('vi_msg').value     = msgMatch ? msgMatch[1].trim() : '';
    document.getElementById('liFormContainer').style.display = 'flex';
  } catch(e) { showNotify('Error: ' + e.message, 'error'); }
  finally { document.getElementById('loaderLi').classList.remove('on'); }
}

function guardarVistage() {
  const nombre  = document.getElementById('vi_nombre').value.trim();
  const company = document.getElementById('vi_company').value.trim();
  const msg     = document.getElementById('vi_msg').value.trim();
  if (!nombre && !company) { showNotify('Complet√° al menos nombre o empresa', 'error'); return; }

  const row = [company,'',nombre,'',document.getElementById('vi_rubro').value,'0 - Enviado Linkedin',
    new Date().toLocaleDateString('es-AR'),'','','','',''];
  if (!window._vistageRows) window._vistageRows = [];
  window._vistageRows.unshift(row);
  renderVistage();

  // Guardar en historial local
  if (msg) {
    agregarEntradaHistorial(company||nombre, {tipo:'linkedin', quien:'Comercial', contenido: msg});
  }

  if (SCRIPT_URL) {
    callScript('addVistage', {company, nombre, rubro:document.getElementById('vi_rubro').value, primerMensaje:msg}).catch(()=>{});
  }

  showNotify(`‚úì ${nombre||company} guardado en Vistage`, 'success');
  ['liTexto','liUrl','liRubro','vi_nombre','vi_company','vi_cargo','vi_rubro','vi_msg'].forEach(id =>
    document.getElementById(id).value = '');
  document.getElementById('liFormContainer').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NUEVO LEAD MANUAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function guardarNuevoLead() {
  const empresa = document.getElementById('nl_empresa').value.trim();
  if (!empresa) { showNotify('Complet√° la empresa', 'error'); return; }

  setLead({
    empresa, contacto: document.getElementById('nl_contacto').value,
    cargo: document.getElementById('nl_cargo').value,
    rubro: document.getElementById('nl_rubro').value,
    wpp:   document.getElementById('nl_wpp').value,
    mail:  document.getElementById('nl_mail').value,
    medio: document.getElementById('nl_origen').value,
    estado: document.getElementById('nl_estado').value,
    proxAccion: hoy(0), semaforo:'üü° Hoy',
    proxPaso: document.getElementById('nl_paso').value,
  });

  renderAll();
  closeModal('modalNuevoLead');
  showNotify(`‚úì ${empresa} agregado`, 'success');
  ['nl_empresa','nl_contacto','nl_cargo','nl_rubro','nl_wpp','nl_mail','nl_paso'].forEach(id =>
    document.getElementById(id).value = '');
}

function copiarMensajeAI() {
  const msg = document.getElementById('pf_ai_msg').textContent.trim();
  if (!msg) { showNotify('No hay mensaje para copiar', 'error'); return; }
  navigator.clipboard.writeText(msg).then(() => {
    showNotify('‚úì Mensaje copiado', 'success');
    // Auto-guardar en historial como mensaje generado por IA
    const lead = getLead(currentPerfilKey);
    if (lead) {
      agregarEntradaHistorial(lead.empresa, {
        tipo: (lead.wpp && lead.wpp!=='nan') ? 'wpp' : (lead.mail && lead.mail!=='nan') ? 'mail' : 'linkedin',
        quien: 'Comercial',
        contenido: '[IA] ' + msg
      });
      renderHistorialPerfil(getLead(currentPerfilKey));
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLAUDE API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function callClaude(prompt) {
  // Intentar llamada directa primero
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 1000,
        messages: [{ role:'user', content: prompt }]
      })
    });
    if (res.ok) {
      const d = await res.json();
      return d.content[0].text;
    }
    // Si falla por CORS o 4xx, intentar via proxy
    const err = await res.json().catch(()=>({}));
    if (res.status === 401) throw new Error('API Key inv√°lida. Verific√° en ‚öôÔ∏è Configuraci√≥n.');
    throw new Error(err.error?.message || 'Error ' + res.status);
  } catch(e) {
    // Si es error de red (CORS), usar proxy
    if (e.message.includes('fetch') || e.message.includes('network') || e.message.includes('Failed')) {
      return await callClaudeProxy(prompt);
    }
    throw e;
  }
}

async function callClaudeProxy(prompt) {
  // Proxy CORS-free via corsproxy.io
  const PROXY = 'https://corsproxy.io/?https://api.anthropic.com/v1/messages';
  const res = await fetch(PROXY, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': API_KEY,
      'anthropic-version': '2023-06-01'
    },
    body: JSON.stringify({
      model: 'claude-haiku-4-5-20251001',
      max_tokens: 1000,
      messages: [{ role:'user', content: prompt }]
    })
  });
  if (!res.ok) {
    const e = await res.json().catch(()=>({}));
    throw new Error(e.error?.message || 'Error proxy ' + res.status);
  }
  const d = await res.json();
  return d.content[0].text;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE APPS SCRIPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function callScript(action, body={}) {
  if (!SCRIPT_URL) throw new Error('Script URL no configurada');
  const res = await fetch(SCRIPT_URL + '?action=' + action, {
    method:'POST',
    body: JSON.stringify({action,...body}),
    headers:{'Content-Type':'application/json'}
  });
  const d = await res.json();
  if (d.error) throw new Error(d.error);
  return d;
}

function saveScriptUrl() {
  const url = document.getElementById('scriptUrl').value.trim();
  if (!url.startsWith('https://script.google.com')) {
    showNotify('URL inv√°lida', 'error'); return;
  }
  SCRIPT_URL = url;
  localStorage.setItem('ef_script_url', url);
  document.getElementById('scriptStatus').innerHTML = '<span style="color:var(--green)">‚úì Guardada</span>';
  showNotify('URL guardada ‚úì', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPanel(name, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  if (btn) btn.classList.add('active');
  const titles = {
    semana:'Plan <em>Semanal</em>', leads:'<em>Leads</em> 2026',
    vistage:'<em>Vistage</em> 2026', cargar:'Cargar desde <em>LinkedIn</em>',
    config:'<em>Configuraci√≥n</em>'
  };
  document.getElementById('pageTitle').innerHTML = titles[name]||name;
}

function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function selectCanal(c, el) {
  selectedCanal = c;
  document.querySelectorAll('#pf_canal_row .canal-opt').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
}

function copyElText(id) {
  const text = document.getElementById(id).textContent;
  navigator.clipboard.writeText(text).then(() => showNotify('‚úì Copiado', 'success'));
}

function showNotify(msg, type='success') {
  const n = document.getElementById('notify');
  n.textContent = msg; n.className = `notify show ${type}`;
  setTimeout(() => n.classList.remove('show'), 3000);
}

// Cerrar modal al clickear overlay
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ARRANQUE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.onload = checkSetup;
</script>
</body>
</html>
